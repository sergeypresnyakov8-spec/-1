<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <meta name="theme-color" content="#1e293b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="–°–ú–ï–ù–ê 2.3" />
  <title>–°–º–µ–Ω–Ω—ã–π –†–∞–ø–æ—Ä—Ç v2.3</title>

  <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (—É–¥–æ–±–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    *{ -webkit-tap-highlight-color: transparent; -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; box-sizing:border-box; }
    input,select,textarea,button{ -webkit-user-select:text; user-select:text; }

    html,body{ width:100%; height:100%; margin:0; padding:0; }
    body{ font-family:'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f8fafc; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    #root{ min-height:100vh; display:flex; flex-direction:column; }

    /* Inputs */
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    input[type=number]{ -moz-appearance:textfield; }

    /* select arrow */
    select{
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position:right .6rem center;
      background-repeat:no-repeat;
      background-size:1em 1em;
      padding-right:2.25rem;
      -webkit-appearance:none; appearance:none;
    }

    .tap-scale{ transition: transform .12s ease; will-change:transform; }
    .tap-scale:active{ transform:scale(.97); }

    .scroll-container{ -webkit-overflow-scrolling:touch; overflow-y:auto; flex:1; }

    .header-top{ padding-top:var(--safe-top,8px); }

    .touch-target{ min-height:44px; min-width:44px; }

    /* tiny helpers */
    .notification-success{ background:linear-gradient(135deg,#059669 0%,#10b981 100%); }
    .notification-error{ background:linear-gradient(135deg,#dc2626 0%,#ef4444 100%); }
    .notification-warning{ background:linear-gradient(135deg,#d97706 0%,#f59e0b 100%); }
    .notification-loading{ background:linear-gradient(135deg,#1e40af 0%,#3b82f6 100%); }

    /* Ensure no accidental spaces in class names usage */
  </style>
</head>
<body class="text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;

    // –ó–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∞ URL –≤–∞—à–µ–≥–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ Apps Script (–≤ —Ñ–æ—Ä–º–∞—Ç–µ /exec)
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzJxb-BS8Dyd46rrRF4hxWyFmnTyE3Q8AyHZGI0emdKVrZIWZlIyrJLLn2zC4mrEuDTrw/exec";

    const REGISTRY = {
      packets: [
        { id: 1, name: "–ö—É—Ä—å–µ—Ä—Å–∫–∏–π –ø–∞–∫–µ—Ç –ö–ü2 400*400+40–º–º (50 –º–∫–º)", plan: 70 },
        { id: 2, name: "–ö—É—Ä—å–µ—Ä—Å–∫–∏–π –ø–∞–∫–µ—Ç 300*400+40–º–º (50 –º–∫–º)", plan: 100 },
        { id: 3, name: "–ö—É—Ä—å–µ—Ä—Å–∫–∏–π –ø–∞–∫–µ—Ç –ö–ü2 300*400+40–º–º (50 –º–∫–º)", plan: 100 }
      ],
      extrusion: [
        { id: 101, name: "–ü–ª–µ–Ω–∫–∞ WB 835*0,045 (–ß–µ—Ä–Ω–æ-–±–µ–ª–∞—è)", plan: 60 },
        { id: 102, name: "–ü–ª–µ–Ω–∫–∞ WB 540*0,045 (–ß–µ—Ä–Ω–æ-–±–µ–ª–∞—è)", plan: 55 }
      ],
      print: [
        { id: 201, name: "–ü–µ—á–∞—Ç—å –õ–∞ –ú–æ–¥–∞ –¢01 700*35", plan: 100 },
        { id: 202, name: "–ü–µ—á–∞—Ç—å –õ–∞ –ú–æ–¥–∞ –¢05 1370*50", plan: 100 }
      ],
      granule: [
        { id: 301, name: "–ì—Ä–∞–Ω—É–ª–∞ —Ü–≤–µ—Ç–Ω–∞—è", plan: 70 },
        { id: 302, name: "–ì—Ä–∞–Ω—É–ª–∞ –±–µ–ª–∞—è", plan: 60 }
      ]
    };

    const DEPARTMENTS = [
      { id: 'packets', label: '–ü–∞–∫–µ—Ç—ã', icon: 'üì¶' },
      { id: 'extrusion', label: '–≠–∫—Å—Ç—Ä—É–∑–∏—è', icon: 'üåÄ' },
      { id: 'print', label: '–ü–µ—á–∞—Ç—å', icon: 'üé®' },
      { id: 'granule', label: '–ì—Ä–∞–Ω—É–ª—ã', icon: 'üíé' }
    ];

    const MASTERS = ["–¢—É–π–≥—É–Ω–æ–≤–∞ –õ. –ì.", "–ì–æ–Ω—á–∞—Ä –û. –ò.", "–í–∏–Ω–æ–≥—Ä–∞–¥–æ–≤–∞ –¢. –Æ."];

    function App() {
      const [loading, setLoading] = useState(false);
      const [status, setStatus] = useState(null);
      const [statusMessage, setStatusMessage] = useState("");
      const scrollRef = useRef(null);

      const [history, setHistory] = useState(() => {
        try {
          const saved = localStorage.getItem('shift_history_v6');
          return saved ? JSON.parse(saved) : [];
        } catch (e) {
          return [];
        }
      });

      const [form, setForm] = useState({
        date: new Date().toISOString().split('T')[0],
        shift: '1 —Å–º–µ–Ω–∞',
        master: '',
        dept: 'packets',
        machine: '',
        operator: '',
        item: '',
        factSpeed: '',
        planSpeed: '',
        outputPcs: '',
        outputKg: '',
        wasteKg: ''
      });

      // persist history -> localStorage (debounced)
      useEffect(() => {
        const t = setTimeout(() => {
          try { localStorage.setItem('shift_history_v6', JSON.stringify(history)); } catch(e) {}
        }, 300);
        return () => clearTimeout(t);
      }, [history]);

      // autofill planSpeed when item changes
      useEffect(() => {
        const list = REGISTRY[form.dept] || [];
        const found = list.find(i => i.name === form.item);
        setForm(f => ({ ...f, planSpeed: found ? found.plan : '' }));
      }, [form.item, form.dept]);

      const totals = useMemo(() => history.reduce((acc, curr) => ({
        weight: acc.weight + (parseFloat(curr.outputKg) || 0),
        count: acc.count + 1
      }), { weight: 0, count: 0 }), [history]);

      // helper: send single entry to Apps Script
      const sendToGoogleSheets = useCallback(async (entry) => {
        try {
          const res = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry)
          });
          if (!res.ok) {
            console.warn('Server responded not ok', res.status);
            return false;
          }
          const json = await res.json();
          // treat duplicate as success
          if (json.success || json.message === 'duplicate' || json.status === 'duplicate') return true;
          return false;
        } catch (err) {
          console.error('‚úó –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
          return false;
        }
      }, []);

      // mark entry synced in local history
      const markEntrySynced = useCallback((id) => {
        setHistory(prev => prev.map(h => h.id === id ? { ...h, synced: true } : h));
      }, []);

      // small delay
      const delay = ms => new Promise(r => setTimeout(r, ms));

      // sync pending (oldest first)
      const syncPending = useCallback(async () => {
        const pending = history.filter(h => !h.synced);
        if (pending.length === 0) {
          setStatus('success');
          setStatusMessage('–ù–µ—Ç –Ω–µ–∑–∞—Å–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π');
          setTimeout(() => setStatus(null), 1200);
          return;
        }

        setStatus('loading');
        setStatusMessage(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ${pending.length} –∑–∞–ø–∏—Å–µ–π...`);

        // oldest-first
        const toSend = [...pending].reverse();

        for (const entry of toSend) {
          let attempt = 0;
          let ok = false;
          while (attempt < 3 && !ok) {
            attempt++;
            ok = await sendToGoogleSheets(entry);
            if (!ok) await delay(1000 * attempt);
          }
          if (ok) markEntrySynced(entry.id);
          else {
            setStatus('warning');
            setStatusMessage('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞ ‚Äî –Ω–µ—Ç —Å–≤—è–∑–∏');
            setTimeout(() => setStatus(null), 2000);
            return;
          }
        }

        setStatus('success');
        setStatusMessage('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        setTimeout(() => setStatus(null), 1500);
      }, [history, sendToGoogleSheets, markEntrySynced]);

      // auto sync on going online
      useEffect(() => {
        const onOnline = () => syncPending();
        window.addEventListener('online', onOnline);
        return () => window.removeEventListener('online', onOnline);
      }, [syncPending]);

      // handle submit (save local + try send)
      const handleSubmit = useCallback(async (e) => {
        e.preventDefault();
        if (!form.machine || !form.item || !form.outputKg) return;

        setLoading(true);
        setStatus('loading');
        setStatusMessage('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');

        const entry = {
          ...form,
          id: Date.now().toString(),
          time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
          synced: false
        };

        // save locally (newest-first)
        setHistory(prev => [entry, ...prev]);

        // try immediate send
        const sent = await sendToGoogleSheets(entry);
        if (sent) {
          markEntrySynced(entry.id);
          setStatus('success');
          setStatusMessage('‚úì –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É');
        } else {
          setStatus('warning');
          setStatusMessage('‚ö† –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ—Ç —Å–≤—è–∑–∏)');
        }

        // reset product fields only
        setForm(f => ({ ...f, machine: '', item: '', factSpeed: '', planSpeed: '', outputPcs: '', outputKg: '', wasteKg: '' }));

        if (scrollRef.current) scrollRef.current.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => setStatus(null), 1800);
        setLoading(false);
      }, [form, sendToGoogleSheets, markEntrySynced]);

      const handleFinish = useCallback(() => {
        if (!confirm('–°–¥–∞—Ç—å —Å–º–µ–Ω—É? –í—Å—è –∏—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞.')) return;
        setHistory([]);
        setForm(f => ({ ...f, master: '' }));
      }, []);

      // UI building
      const inputBase = "w-full px-4 py-3 bg-white border border-slate-200 rounded-xl shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all";
      const labelBase = "block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider";

      return (
        <div className="w-full min-h-screen flex flex-col bg-slate-50">
          {/* Header */}
          <div className="header-top bg-slate-900 text-white p-4 rounded-b-3xl shadow flex-shrink-0">
            <div className="max-w-lg mx-auto flex items-center justify-between">
              <div>
                <h1 className="font-black text-lg">–°–ú–ï–ù–ê <span className="text-blue-400">2.3</span></h1>
                <p className="text-[10px] mt-1 text-slate-300 uppercase">{form.date} ‚Ä¢ {form.shift}</p>
              </div>
              <div className="flex items-center gap-2">
                <button type="button" onClick={syncPending} className="px-3 py-2 bg-emerald-500 rounded-lg text-xs font-bold touch-target">–°–∏–Ω—Ö—Ä.</button>
                <button type="button" onClick={() => alert('–°–¥–µ–ª–∞—Ç—å PWA: –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω')} className="px-3 py-2 bg-slate-700 rounded-lg text-xs font-bold">?</button>
              </div>
            </div>
          </div>

          <div className="scroll-container">
            <div className="max-w-lg mx-auto p-4 pb-12">
              {/* Master */}
              <div className={`p-3 rounded-2xl border-2 ${form.master ? 'bg-emerald-50 border-emerald-100' : 'bg-white border-blue-200 shadow'}`}>
                <label className={labelBase + " text-blue-500"}>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –º–∞—Å—Ç–µ—Ä</label>
                <select className="w-full bg-transparent font-bold text-base" value={form.master} onChange={e => setForm({ ...form, master: e.target.value })}>
                  <option value="">-- –í–´–ë–ï–†–ò–¢–ï –ú–ê–°–¢–ï–†–ê --</option>
                  {MASTERS.map(m => <option key={m} value={m}>{m}</option>)}
                </select>
              </div>

              {/* Dept */}
              <div className="mt-4 grid grid-cols-4 gap-2">
                {DEPARTMENTS.map(d => (
                  <button key={d.id} type="button" onClick={() => setForm({ ...form, dept: d.id, item: '' })}
                    className={`tap-scale p-2 rounded-xl border flex flex-col items-center text-[12px] ${form.dept === d.id ? 'bg-blue-600 text-white' : 'bg-white text-slate-500'}`}>
                    <div>{d.icon}</div>
                    <div className="mt-1 font-bold">{d.label}</div>
                  </button>
                ))}
              </div>

              {/* Form */}
              <form onSubmit={handleSubmit} className="mt-4 space-y-4">
                <div className="bg-white p-4 rounded-2xl border shadow-sm">
                  <div className="flex gap-3">
                    <div className="w-24">
                      <label className={labelBase}>–ú–∞—à. ‚Ññ</label>
                      <input type="text" inputMode="numeric" placeholder="00" required className={inputBase + " text-center font-black"} value={form.machine} onChange={e => setForm({ ...form, machine: e.target.value })} maxLength="4" />
                    </div>
                    <div className="flex-1">
                      <label className={labelBase}>–û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                      <input type="text" placeholder="–§–∞–º–∏–ª–∏—è" className={inputBase} value={form.operator} onChange={e => setForm({ ...form, operator: e.target.value })} autoComplete="off" />
                    </div>
                  </div>

                  <div className="mt-3">
                    <label className={labelBase}>–ò–∑–¥–µ–ª–∏–µ</label>
                    <select required className={inputBase + " font-semibold"} value={form.item} onChange={e => setForm({ ...form, item: e.target.value })}>
                      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É --</option>
                      {REGISTRY[form.dept]?.map(i => <option key={i.id} value={i.name}>{i.name}</option>)}
                    </select>
                  </div>

                  <div className="grid grid-cols-2 gap-3 mt-3">
                    <div>
                      <label className={labelBase}>–§–∞–∫—Ç. —Å–∫–æ—Ä–æ—Å—Ç—å</label>
                      <input type="number" inputMode="numeric" className={inputBase + " font-bold"} value={form.factSpeed} onChange={e => setForm({ ...form, factSpeed: e.target.value })} />
                    </div>
                    <div>
                      <label className={labelBase}>–ü–ª–∞–Ω</label>
                      <div className="p-3 bg-slate-50 border rounded-xl text-center font-bold text-slate-400">{form.planSpeed || '--'}</div>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  {form.dept === 'packets' && (
                    <div className="col-span-2 bg-white p-4 rounded-2xl border">
                      <label className={labelBase + " text-blue-600"}>–í—ã—Ä–∞–±–æ—Ç–∫–∞ (–®—Ç—É–∫)</label>
                      <input type="number" inputMode="numeric" placeholder="0" className="w-full text-2xl font-black text-blue-600 bg-transparent outline-none text-right" value={form.outputPcs} onChange={e => setForm({ ...form, outputPcs: e.target.value })} />
                    </div>
                  )}

                  <div className="bg-white p-4 rounded-2xl border">
                    <label className={labelBase + " text-emerald-600"}>–í–µ—Å –ö–ì (–§–∞–∫—Ç)</label>
                    <input type="number" step="0.1" inputMode="decimal" required placeholder="0.0" className="w-full text-2xl font-black text-emerald-600 bg-transparent outline-none text-right" value={form.outputKg} onChange={e => setForm({ ...form, outputKg: e.target.value })} />
                  </div>

                  <div className="bg-white p-4 rounded-2xl border">
                    <label className={labelBase + " text-rose-600"}>–û—Ç—Ö–æ–¥ –ö–ì</label>
                    <input type="number" step="0.1" inputMode="decimal" placeholder="0.0" className="w-full text-2xl font-black text-rose-600 bg-transparent outline-none text-right" value={form.wasteKg} onChange={e => setForm({ ...form, wasteKg: e.target.value })} />
                  </div>
                </div>

                <button type="submit" disabled={loading} className="w-full py-4 rounded-2xl bg-slate-900 text-white font-bold uppercase tap-scale">
                  {loading ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–ó–∞–ø–∏—Å–∞—Ç—å –≤ –æ—Ç—á–µ—Ç'}
                </button>
              </form>

              {/* History */}
              <div className="mt-8">
                <div className="flex justify-between items-center mb-3">
                  <h3 className="text-xs font-bold text-slate-500 uppercase">–õ–æ–≥ —Å–º–µ–Ω—ã</h3>
                  <div className="text-right text-xs">
                    <div>–ò—Ç–æ–≥–æ –ö–ì: <span className="font-black text-emerald-600">{totals.weight.toFixed(1)}</span></div>
                    <div>–ó–∞–ø–∏—Å–µ–π: <span className="font-bold">{totals.count}</span></div>
                  </div>
                </div>

                <div className="space-y-2">
                  {history.length === 0 ? (
                    <div className="bg-slate-100 border-dashed border-2 p-6 rounded-2xl text-center text-slate-400 uppercase font-bold">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>
                  ) : (
                    history.map(item => (
                      <div key={item.id} className="bg-white p-3 rounded-xl border flex items-start gap-3">
                        <div className="w-10 h-10 bg-slate-50 rounded-lg flex items-center justify-center text-lg">{DEPARTMENTS.find(d => d.id === item.dept)?.icon}</div>
                        <div className="flex-1 min-w-0">
                          <div className="flex justify-between items-start mb-1">
                            <div className="text-xs font-black text-blue-600">–ú‚Ññ{item.machine} ‚Ä¢ {item.master || form.master}</div>
                            <div className="text-xs text-slate-400">{item.time}</div>
                          </div>
                          <div className="flex items-center justify-between gap-2">
                            <div className="text-sm font-semibold text-slate-800 truncate">{item.item}</div>
                            <div className="flex items-center gap-2">
                              {item.synced ? (
                                <span className="text-[12px] font-bold text-emerald-600">‚úì</span>
                              ) : (
                                <span className="text-[10px] font-bold text-amber-500">‚óè</span>
                              )}
                            </div>
                          </div>
                          <div className="mt-2 flex gap-2 text-xs">
                            <div className="px-2 py-0.5 bg-emerald-50 rounded text-emerald-700 font-bold">–ö–≥: {item.outputKg}</div>
                            {item.outputPcs && <div className="px-2 py-0.5 bg-blue-50 rounded text-blue-700 font-bold">–®—Ç: {item.outputPcs}</div>}
                            {item.wasteKg && <div className="px-2 py-0.5 bg-rose-50 rounded text-rose-700 font-bold">–û—Ç—Ö–æ–¥: {item.wasteKg}</div>}
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>

                {history.length > 0 && (
                  <div className="mt-4">
                    <button onClick={handleFinish} className="w-full py-3 rounded-2xl border-2 text-rose-600 font-bold">–°–¥–∞—Ç—å —Å–º–µ–Ω—É</button>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Notification */}
          {status && (
            <div className={`fixed bottom-6 left-4 right-4 max-w-lg mx-auto text-white p-3 rounded-xl shadow z-50 ${status==='success'?'notification-success':status==='error'?'notification-error':status==='warning'?'notification-warning':'notification-loading'}`}>
              <div className="flex items-center gap-3">
                <div className="text-lg">{status === 'success' ? '‚úì' : status === 'error' ? '‚úï' : status === 'warning' ? '‚ö†' : '‚è≥'}</div>
                <div className="text-xs font-bold uppercase">{statusMessage}</div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>
